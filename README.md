This repository contains code for simulating Richards equation and for approximating the solution using continuous data assimilation (AOT), Ensemble Kalman Filter (EnKF), and a simple nudging-based algorithm.

## Generating Precipitation File
To run the code, a text file containing precipitation and evaporation values must be provided. A properly formatted text file may be generated by running the matlab code Main_Generate_Precip_PET_Hydrus_Inputs.m. Further details on this code and how values are generated may be found in Forcings_Description.docx.

## Running the Code
To run the code in a Linux terminal, use the command 'python <main.py> <input.txt>, replacing the locations of main.py and intput.txt. This will create a results folder, which will contain graphs depicting soil water content and mass balance over time, as well as RMSE plots if at least one data assimilation algorithm was run along with the solver. Additionally, a .mat file containing time, water content, and pressure head values will be generated - depending on the size of the time steps and the length of time run, this file may be very large.

## Adjusting Parameters
There are a number of paramters and functions that may be adjusted, depending on the desired results. These are listed according to location.
### main.py
The file main.py contains a majority of the parameters that may be adjusted. 
* Spatial Parameters:
  + max_x : The location of the top of the soil column. By default, it is set to 0cm (the surface).
  + min_x : The location of the base of the soil column (in cm). It must be a negative value. By default, it is set to -200 (that is, a depth of 200 cm).
  + nx : The number of intervals in the mesh. Currently, it is set to 200 intevals, resulting in a 1 cm spatial mesh.
* Time Parameters:
  + dt : The initial/default numerical timestep for Richards solver (in min). By default, it is set to 1 min.
  + aot_dt : The initial/default numerical timestep for DA schemes (in min). By default, it is set to 1 min.
  + T : The simulation end time (in min). By default, it is set to 1440 min (or 1 day).
  + dt_min: The minimum numerical timestep allowed (in min). By default, it is set to 0.5 min.
  + dt_max: The maximum numerical timestep in min. By default, it is set to 60 min. Note that this is only used if adaptive time stepping is turned on in iterated_solver(), aot_solver(), kalman_solver(), or nudging_solver().
* Picard Parameters:
  + tol: The allowed pressure head RMSE tolerated by Picard. By default, it is set to 1. It may need to be increased if the Richards solver is failing to converge.
  + max_iter: The maximum allowed number of Picard iterations. By default, it is set to 50. Should Picard fail to converge within the alotted number of iterations, the programs will terminate.
  + tol_dA: The Picard tolerance for data assimilation schemes. It functions in the same way as tol, and by default is set to 1.
  + max_iter_dA: The maximum number of Picard iterations allowed for data assimilation schemes. It functions much the same was as max_iter, and by default is set to 50.
* Initial Conditions:
  + h_0: The actual initial pressure head, used by iterated_solver() to numerically solver Richards equation, in the form of a FEniCS Expression. By default, set to -336.506 cm constant throughout the column.
  + h_0_dA = The approximate initial pressure head, used by the data assimlation solvers to approximate the actual solution found by iterated_solver(), in the form of a FEniCS Expression. By default, set to -136.506 cm constant throughout the column.
* Data Assimilation Parameters:
  + crns_time: The frequency (in min) in which CRNS data is incorporated. Set to 0 to turn off, by default, set to 60. Note that this is only used if the feedback type used in da_support.py is Ih_combined() or Ih_CRNS().
  + sat_time: The freqency (in min) in which remote data is incorporated. Set to 0 to turn off, is 0 by default. Note that is is only used if the feedback type used in da_support.py is Ih_combined() or Ih_remote().
  + num_ensembles: The number of ensembles used in EnKF data assimilation.
  
There are four main solver functions that are called by main.py by default: iterated_solver(), which simply solves Richards numerically (using the method proposed by Celia et. al. in 1990) and must be called regardless of the type of data assimilation chosen, nad three different data assimilation approximation methods: aot_solver(), nudging_solver(), and kalman_solver(). Depending on the type of data assimilation method one wishes to use, any or all of these function calls by be commented out.

### boundaries.py
There are a couple parameters that may need to be adjusted depending on the boundary type.
* top_bound: Sets the type of the surface boundary condition. For constant pressure head (Dirichlet), set to 0. For constant flux (Neumann), set to 1. For varied flux (using precipitation file generated by Main_Generate_Precip_PET_Hydrus_Inputs.m), set to 2.
* bottom_bound = Sets the type of the boundary condition at the base. For constant pressure head (Dirichlet), set to 0. For constant flux (Neumann), set to 1. For free drainage, set to 2.
* g_top = The constant flux at the surface (per time unit); used if top_bound = 1.
* g_bottom: The constant flux at the bottom of the soil column (per time unit); used if bottom_bound = 1.

Note that if either top_bound = 0 or bottom_bound = 0, the bounds will be dependent upon the pressure head at the surface and base set by the initial contion h_0 or h_0_dA in main.py.

### soil_params.py
To set the type of soil, change the function called in get_soil_params(). By default, a sandy loam type soil is used. Other available types of soil include sand, loam, loamy sand, and silty clay. There is also a function for custom soil parameters, which may be altered to yield other soil types. Just note that parameter units are in cm and min.

### da_support.py
To alter the number of observation nodes, the frequency of observations (in min), or the nudging constant mu, change the parameters in the function get_aot_params(). Note that all three must be positive values. Collect_time should not be smaller than the time_step dt, num_nodes should not exceed nx + 1, and if aot_solver is failing to converge, mu may be too large.

The type of observations/interpolation used may be altered in the function feedback(). By default, Ih_combined is selected, which simulates uniformly spaced point-sensor (node-based) observations (with a linear piecewise interpolation used to approximate non-observed nodes), and supports the inclusion of CRNS and/or remote (integrated) data. For uniformly spaced nodes only, use Ih_piecewise_uni(), or set crns_time and sat_time to 0. For specific node placements, use Ih_piecewise_spec() - this function may need to be further adjusted depending on the specific locations desired. For nodal observations without the linear interpolation for un-observed points, used Ih_zeros(). For only CRNS or remote data, use Ih_CRNS() or Ih_Remote().

### kalman.py
The noise used in EnKF may be adjusted in this file. There are three noise parameters, all are set by default to 1e-12:
* gamma: Ensemble generated noise (model error) standard deviation
* sigma: Observation noise standard deviation
* delta: Inflation standard deviation

### Adaptive Time Stepping
The functions iterated_solver(), aot_solver(), nudging_solver(), and kalman_solver() in the files solver.py, aot.py, nudging.py, and kalman.py respectively each contain a commented piece of code that allows for more adaptive time stepping. This may be uncommented to allow for more efficient runs, but may also result in worse convergence and mass conservation.

## Note about FEniCS
This code makes use of FEniCS; details may be found here:
* M. S. Alnaes, J. Blechta, J. Hake, A. Johansson, B. Kehlet, A. Logg, C. Richardson, J. Ring, M. E. Rognes and G. N. Wells. The FEniCS Project Version 1.5, Archive of Numerical Software 3 (2015). [doi.org/10.11588/ans.2015.100.20553]
* A. Logg, K.-A. Mardal, G. N. Wells et al. Automated Solution of Differential Equations by the Finite Element Method, , Springer(2012). [doi.org/10.1007/978-3-642-23099-8]

